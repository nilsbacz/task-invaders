name: CI

on:
    pull_request:
    push:
        branches: [ main ]

permissions:
    contents: read

jobs:
    lint:
        name: php lint
        runs-on: ubuntu-latest

        steps:
            -   uses: actions/checkout@v4

            -   uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.4'
                    extensions: mbstring, intl, pdo_mysql, zip
                    coverage: none
                    tools: composer:v2

            -   name: Cache Composer
                uses: actions/cache@v4
                with:
                    path: ~/.composer/cache/files
                    key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
                    restore-keys: |
                        composer-${{ runner.os }}-

            -   name: Install Composer deps
                run: composer install --no-interaction --prefer-dist --no-progress

            -   name: Lint (PHP_CodeSniffer)
                run: ./vendor/bin/phpcs --standard=phpcs.xml

            -   name: Static analysis (PHPStan)
                run: ./vendor/bin/phpstan analyse -c phpstan.neon

    tests:
        name: php unit
        runs-on: ubuntu-latest

        services:
            mysql:
                image: mysql:8.4
                env:
                    MYSQL_DATABASE: task-invaders_test
                    MYSQL_USER: task-invaders
                    MYSQL_PASSWORD: task-invaders
                    MYSQL_ROOT_PASSWORD: rootsecret
                ports: [ "3306:3306" ]
                options: >-
                    --health-cmd="mysqladmin ping -h 127.0.0.1 -prootsecret"
                    --health-interval=5s --health-timeout=5s --health-retries=20

        env:
            APP_ENV: test
            APP_DEBUG: 0
            DATABASE_URL: "mysql://task-invaders:task-invaders@127.0.0.1:3306/task-invaders?serverVersion=8.4&charset=utf8mb4"

        steps:
            -   uses: actions/checkout@v4

            -   uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.4'
                    extensions: mbstring, intl, pdo_mysql, zip
                    coverage: xdebug
                    tools: composer:v2

            -   name: Cache Composer
                uses: actions/cache@v4
                with:
                    path: ~/.composer/cache/files
                    key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
                    restore-keys: |
                        composer-${{ runner.os }}-

            -   name: Install Composer deps
                run: composer install --no-interaction --prefer-dist --no-progress

            -   name: Create database (if needed)
                run: php bin/console doctrine:database:create --if-not-exists --env=test

            -   name: Run migrations
                run: php bin/console doctrine:migrations:migrate --no-interaction --env=test

            -   name: Run tests (with coverage)
                env:
                    XDEBUG_MODE: coverage
                run: composer test:cov

            -   name: Upload coverage report
                if: always()
                uses: actions/upload-artifact@v4
                with:
                    name: coverage-html
                    path: var/coverage/html
